<link href="https://fonts.googleapis.com/css2?family=Tangerine&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=MedievalSharp&family=Eagle+Lake:wght@400&display=swap" rel="stylesheet">
<form class="{{cssClass}} {{actor.type}} flexcol" autocomplete="off">
<script>
	// Enhanced sheen clipping function
	function updateSheenClipping() {
		// Health bar
		const hpBar = document.querySelector('.hp-bar');
		if (hpBar) {
			const hpFillPercent = (hpBar.value / hpBar.max) * 100;
			const hpSheenWrapper = document.querySelector('.hp-sheen-wrapper');
			if (hpSheenWrapper) {
				hpSheenWrapper.style.width = `${hpFillPercent}%`;
			}
		}
		
		// Mana bar
		const mpBar = document.querySelector('.mp-bar');
		if (mpBar) {
			const mpFillPercent = (mpBar.value / mpBar.max) * 100;
			const mpSheenWrapper = document.querySelector('.mp-sheen-wrapper');
			if (mpSheenWrapper) {
				mpSheenWrapper.style.width = `${mpFillPercent}%`;
			}
		}
		
		// Stamina bar
		const staminaBar = document.querySelector('.stamina-bar');
		if (staminaBar) {
			const staminaFillPercent = (staminaBar.value / staminaBar.max) * 100;
			const staminaSheenWrapper = document.querySelector('.stamina-sheen-wrapper');
			if (staminaSheenWrapper) {
				staminaSheenWrapper.style.width = `${staminaFillPercent}%`;
			}
		}
	}

	// Wait for DOM to be ready with multiple fallbacks
	function initializeSheenClipping() {
		// Try multiple times to ensure elements are loaded
		let attempts = 0;
		const maxAttempts = 10;
		
		function tryUpdate() {
			attempts++;
			const hpBar = document.querySelector('.hp-bar');
			const mpBar = document.querySelector('.mp-bar');
			const staminaBar = document.querySelector('.stamina-bar');
			
			if (hpBar && mpBar && staminaBar) {
				updateSheenClipping();
			} else if (attempts < maxAttempts) {
				setTimeout(tryUpdate, 100);
			}
		}
		
		tryUpdate();
	}

	// Multiple event listeners for better coverage
	document.addEventListener('DOMContentLoaded', initializeSheenClipping);
	
	// Foundry VTT specific events
	document.addEventListener('renderActorSheet', function() {
		setTimeout(initializeSheenClipping, 100);
	});
	
	// Update on any form changes
	document.addEventListener('change', function(e) {
		if (e.target.name && (
			e.target.name.includes('health') || 
			e.target.name.includes('mana') || 
			e.target.name.includes('stamina')
		)) {
			setTimeout(updateSheenClipping, 50);
		}
	});

	// Fallback: Update every 2 seconds to catch any missed updates
	setInterval(function() {
		const hpBar = document.querySelector('.hp-bar');
		if (hpBar) {
			updateSheenClipping();
		}
	}, 2000);

	// Capitalize ability names
	function capitalizeAbilityNames() {
		// Find all ability label b elements
		const abilityLabels = document.querySelectorAll('.ability-label b');
		
		console.log('Found ability labels:', abilityLabels.length);
		
		abilityLabels.forEach(function(element) {
			// Get the text content and remove HTML entities
			let text = element.innerHTML;
			console.log('Original HTML:', text);
			
			// Remove &nbsp; entities and extra spaces
			text = text.replace(/&nbsp;/g, ' ').replace(/\s+/g, ' ').trim();
			console.log('Cleaned text:', text);
			
			if (text && text.length > 0) {
				// Capitalize first letter, lowercase the rest
				const capitalized = text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
				console.log('Capitalized:', capitalized);
				
				// Set the HTML content with proper spacing
				element.innerHTML = capitalized + '&nbsp;&nbsp;';
			}
		});
	}

	// Run capitalization multiple times to catch elements when they load
	function runCapitalizationWithRetries() {
		let attempts = 0;
		const maxAttempts = 10;
		
		function tryCapitalization() {
			attempts++;
			console.log('Capitalization attempt:', attempts);
			
			const abilityLabels = document.querySelectorAll('.ability-label b');
			console.log('Found', abilityLabels.length, 'ability labels');
			
			if (abilityLabels.length > 0) {
				capitalizeAbilityNames();
			} else if (attempts < maxAttempts) {
				setTimeout(tryCapitalization, 100);
			}
		}
		
		tryCapitalization();
	}

	// Run capitalization when DOM is ready
	document.addEventListener('DOMContentLoaded', function() {
		console.log('DOM loaded, running capitalization');
		setTimeout(runCapitalizationWithRetries, 200);
	});
	
	// Foundry VTT specific events
	document.addEventListener('renderActorSheet', function() {
		console.log('Actor sheet rendered, running capitalization');
		setTimeout(runCapitalizationWithRetries, 200);
	});
	
	// Also run on any input changes (in case abilities are updated)
	document.addEventListener('input', function(e) {
		if (e.target.name && e.target.name.includes('abilities')) {
			setTimeout(capitalizeAbilityNames, 100);
		}
	});
</script>
<div class="unique-logo-container">
    <img class="logo" src="systems/stryder/assets/stryderfvtt_title_m.png" width="125" height="125">
</div>
  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}"/>
    <div class="header-fields">
		<div class="fantasy-input" style="width: 450px; display: flex; align-items: center; gap: 20px;">
				<input name="name" type="text" value="{{actor.name}}" placeholder="Name" style="flex: 1;"/>
			<div class="resource flex-group-center" style="margin: 0; padding: 0;">
				<div class="resource-content-level flex-column flex-center">
					<label for="level-value-input" class="resource-label" style="margin-top: -10px; margin-bottom: -15px; color: #000000; !important">{{localize "Rank"}}</label>
					<input type="text" id="level-value-input" name="system.attributes.rank.value" value="{{system.attributes.rank.value}}" data-dtype="Number"/>
				</div>
			</div>
		</div><br />
      {{!-- The grid classes are defined in scss/global/_grid.scss. To use,
      use both the "grid" and "grid-Ncol" class where "N" can be any number
      from 1 to 12 and will create that number of columns.  --}}
        <div class="character-details-secondary textalign-center flexrow">
          <div class="character-species">
            <label for="{{actor._id}}species" class="resource-label-info">{{localize "Species"}}</label> 
            <input id="{{actor._id}}species" type="text" name="system.species" value="{{system.species}}" placeholder="Species Name" data-dtype="String"/>
          </div>
          <div class="character-habitat">
            <label for="{{actor._id}}habitat" class="resource-label-info">{{localize "Habitat"}}</label>
            <input id="{{actor._id}}habitat" type="text" name="system.attributes.habitat" value="{{system.attributes.habitat}}" placeholder="Forest, Mountains, etc." data-dtype="String"/>
          </div>
          <div class="character-weightclass">
            <label for="{{actor._id}}creature_size" class="resource-label-info">{{localize "Creature Size"}}</label>
			<div class="dropdown-field">
				<select class="secondary-input" name="system.attributes.creature_size" style="width: 100%; font-size: 16px; font-weight: normal;">
				  {{#select system.attributes.creature_size}}
				  <option value="0.25">Mini</option>
				  <option value="0.5">Small</option>
				  <option value="1">Normal</option>
				  <option value="2">Huge</option>
				  <option value="3">Massive</option>
				  <option value="4">Colossal</option>
				  <option value="5">Titanic</option>
				  {{/select}}
				</select>
			</div>
          </div>
		</div>
      <div class="resources grid grid-3col">

        {{!-- "flex-group-center" is also defined in the _grid.scss file
        and it will add a small amount of padding, a border, and will
        center all of its child elements content and text. --}}

        <div class="resource flex-group-center">
          <label for="system.health.value" class="resource-label"><img style="width: 15px; height: 15px; border: 0px; position: relative; top: 15px; left: -5px; margin-left: 15px;" src="systems/stryder/assets/health-symbol.svg">{{localize "Health"}}</label>
		  <div class="hpbar">
			<div class="hp-progress-bar">
			  <progress class="hp-bar grid-span-3" value="{{system.health.value}}" max="{{system.health.max}}"></progress>
			  <div class="hp-sheen-wrapper">
				<div class="hp-sheen"></div>
			  </div>
			</div>
		  </div>
          <div class="resource-content flexrow flex-center flex-between">
          <input type="text" name="system.health.value" value="{{system.health.value}}" data-dtype="Number"/>
          <span> / </span>
          <input type="text" name="system.health.max" value="{{system.health.max}}" data-dtype="Number"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.mana.value" class="resource-label"><img style="width: 20px; height: 20px; border: 0px; position: relative; top: 10px; margin-bottom: -5px; left: -5px; margin-left: 15px;" src="systems/stryder/assets/mana-symbol.svg">{{localize "Mana"}}</label>
		  <div class="mpbar">
			<div class="mp-progress-bar">
			  <progress class="mp-bar grid-span-3" value="{{system.mana.value}}" max="{{system.mana.max}}"></progress>
			  <div class="mp-sheen-wrapper">
				<div class="mp-sheen"></div>
			  </div>
			</div>
		  </div>
          <div class="resource-content flexrow flex-center flex-between">
          <input type="text" name="system.mana.value" value="{{system.mana.value}}" data-dtype="Number"/>
          <span> / </span>
          <input type="text" name="system.mana.max" value="{{system.mana.max}}" data-dtype="Number"/>
          </div>
        </div>

        <div class="resource flex-group-center">
          <label for="system.stamina.value" class="resource-label"><img style="width: 20px; height: 20px; border: 0px; position: relative; top: 10px; margin-bottom: -6px; left: 0px; margin-left: 15px;" src="systems/stryder/assets/stamina-symbol.svg">{{localize "Stamina"}} </label>
		  <div class="staminabar">
			<div class="stamina-progress-bar">
			  <progress class="stamina-bar grid-span-3" value="{{system.stamina.value}}" max="{{system.stamina.max}}"></progress>
			  <div class="stamina-sheen-wrapper">
				<div class="stamina-sheen"></div>
			  </div>
			</div>
		  </div>
          <div class="resource-content flexrow flex-center flex-between">
            <input type="text" name="system.stamina.value" value="{{system.stamina.value}}" data-dtype="Number"/>
            <span> / </span>
            <input type="text" name="system.stamina.max" value="{{system.stamina.max}}" data-dtype="Number"/>
          </div>
        </div>

      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    {{!-- Default tab is specified in actor-sheet.mjs --}}
    <a class="item" data-tab="features">Battle</a>
    <a class="item" data-tab="battle">Features</a>
    <a class="item" data-tab="description">Information</a>
    <a class="item" data-tab="effects">Effects</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Owned Features Tab --}}
    <div class="tab features" data-group="primary" data-tab="features">
      <section class="grid grid-3col">
        <aside class="sidebar">

          {{!-- The grid classes are defined in scss/global/_grid.scss. To use,
          use both the "grid" and "grid-Ncol" class where "N" can be any number
          from 1 to 12 and will create that number of columns.  --}}
          <div class="abilities flexcol fantasy-abilities">
            <div class="abilities-header">
              <h3 class="fantasy-section-title">
                <span class="title-decoration left"></span>
                <span class="title-text">Abilities</span>
                <span class="title-decoration right"></span>
              </h3>
            </div>
            {{#each system.abilities as |ability key|}}
            <div class="ability flexrow flex-group-center stat-font fantasy-ability">
              <label class="ability-label" title="{{#if (eq key 'Soul')}}This stat measures the strength of your Soul Armament. This affects the damage your attacks and Skills deal. It also raises your Physical Potency making your Skills harder to Resist.{{else if (eq key 'Reflex')}}Combat reflexes and evasiveness. Reflexes provides survivability on the battlefield as well as increasing your ability to Dodge.{{else if (eq key 'Grit')}}Physical Durability and Resilience unmatched. You gain additional Health, and an increased Physical Resistance making you harder to overwhelm.{{else if (eq key 'Arcana')}}A visible level of your bodies upper limits for wielding Hexes and otherwise using Mana. This Stat augments the damage and effects Hexes will produce, as well as raising your Magykal Potency, making some Hexes and effects harder to Resist.{{else if (eq key 'Intuition')}}Combat Knowledge and Experience are represented by Intuition. Intuition grants simple but useful abilities.{{else if (eq key 'Will')}}Will grants you incredible determination capable of surmounting the odds and even resisting magykal abilities. This Stat raises your Magykal Resist providing additional defense against certain effects.{{else if (eq key 'Spirit')}}The physical embodiment of the fire of a Lordling's existence. Channeled and manifested by their Shaman, Spirit dictates the amount of damage a Lordling can deal when making attacks.{{/if}}"><b>{{ability.label}}&nbsp;&nbsp;</b></label>
              <div class="ability-input-container">
                <input type="text" name="system.abilities.{{key}}.value" value="{{ability.value}}" data-dtype="Number" class="fantasy-ability-input"/>
                <div class="ability-input-glow"></div>
              </div>
              <span class="ability-mod rollable" data-roll="2d6+@abilities.{{key}}.value" data-label="{{ability.label}}">
                <div class="dice-container">
                  <img src="systems/stryder/assets/d6.svg" width=25px height=25px style='border:0px'>
                  <div class="dice-glow"></div>
                </div>
              </span>
            </div>
            {{/each}}
          </div>

		<div class="fantasy-armor-section">
			<div class="armor-header">
				<h3 class="fantasy-section-title">
					<span class="title-decoration left"></span>
					<span class="title-text">Armor</span>
					<span class="title-decoration right"></span>
				</h3>
			</div>
			<div class="armor-content">
				<div class="armor-input-container">
					<input type="text" name="system.armor.value" value="{{system.armor.value}}" data-dtype="Number" class="fantasy-armor-input"/>
					<span class="armor-separator"> / </span>
					<input type="text" name="system.armor.max" value="{{system.armor.max}}" data-dtype="Number" class="fantasy-armor-input"/>
				</div>
			</div>
		</div>

		<div class="fantasy-combat-abilities">
			<div class="combat-abilities-header">
				<h3 class="fantasy-section-title">
					<span class="title-decoration left"></span>
					<span class="title-text">Saves</span>
					<span class="title-decoration right"></span>
				</h3>
			</div>
			
			<!-- Physical Potency & Resist Column -->
			<div class="potency-resist-column">
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button potency-button rollable" data-roll="@attributes.physical_potency.value" data-label="Physical Potency DC">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/physical_potency.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Physical Potency"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
				
				<div class="connect-line"></div>
				
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button resistance-button rollable" data-roll="2d6+@attributes.physical_resistance.base" data-label="Physical Resistance Check">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/physical_resistance.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Resist"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
			</div>

			<!-- Magykal Potency & Resist Column -->
			<div class="potency-resist-column">
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button potency-button rollable" data-roll="@attributes.magykal_potency.value" data-label="Magykal Potency DC">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/magykal_potency.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Magykal Potency"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
				
				<div class="connect-line"></div>
				
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button resistance-button rollable" data-roll="2d6+@attributes.magykal_resistance.base" data-label="Magykal Resistance Check">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/magykal_resistance.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Resist"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
			</div>

			<!-- Dodge & Evade Row -->
			<div class="combat-row dodge-evade-row">
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button ability-dodge-evade-mod rollable" data-custom-roll="1d6+@abilities.Defense.value+@dodge.bonus" data-label="Dodge Roll">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/dodge.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Dodge"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
				
				<div class="fantasy-combat-button-container">
					<span class="fantasy-combat-button ability-dodge-evade-mod rollable" data-custom-roll="2d6+@abilities.Defense.value+@evade.bonus" data-label="Evade Roll">
						<div class="combat-icon-container">
							<img src="systems/stryder/assets/evade.svg" class="combat-icon"/>
							<div class="combat-icon-glow"></div>
						</div>
						<span class="combat-button-text"><strong>{{localize "Evade"}}</strong></span>
						<div class="combat-button-shine"></div>
					</span>
				</div>
			</div>
		</div>
		<br />
        </aside>

        {{!-- For the main features list, span the right two columns --}}
        <section class="main grid-span-2">
          {{!-- This is a Handlebars partial. They're stored in the `/parts` folder next to this sheet, and defined in module/helpers/templates.mjs --}}
          {{> "systems/stryder/templates/actor/parts/monster-features.hbs"}}
        </section>

      </section>
    </div>

<!-- Battle Tab -->

<div class="tab battle" data-group="primary" data-tab="battle">
    <h2 class="section-header" style="border-bottom: 0px;">
        <span class="header-decoration left"></span>
        <img src="systems/stryder/assets/movement-speeds.svg" width="25px" height="25px" style="border:0px; position: relative; top: 0px; left: -10px;">
        <strong>{{localize "Movement Speeds"}}</strong>
        <span class="header-decoration right"></span>
    </h2>
    
    <div class="movement-container">
        <!-- Base Movement Speed -->
        <div class="base-movement-section">
            <div class="flexrow flex-group-center-speed">
                <img src="systems/stryder/assets/run.svg" width="30px" height="30px" style="border:0px; margin-right: -20px; margin-left: -10px;">
                <label><b>{{localize "Current Movement"}}</b></label>
            </div>
            <div class="speed-input-container">
                <span class="speed-input-box">
                    <input type="text" name="system.attributes.move.running.value" value="{{system.attributes.move.running.value}}" data-dtype="Number">
                </span>
            </div>
            
            <!-- Movement Rules Text -->
            <div class="movement-rules">
                <div class="rules-scroll">
                    <p class="rules-text">
                        <span class="rules-highlight">{{localize "Movement Basics"}}:</span> {{localize "Movement Basics Description"}}
                    </p>
                    <p class="rules-text">
                        <span class="rules-highlight">{{localize "Engagement & Recovery"}}:</span> {{localize "Engagement Recovery Description"}}
                    </p>
                    <p class="rules-text">
                        <span class="rules-highlight">{{localize "Baseline & Modifiers"}}:</span> {{localize "Baseline Modifiers Description"}}
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Movement Expertises -->
        <div class="expertise-section">
            <h3 class="expertise-title">{{localize "Movement Expertises"}}</h3>
            <div class="expertise-grid">
                <div class="expertise-item" data-tooltip="<b>Running Expertise:</b> Raises your Movement by 4.">
                    <span class="expertise-label">{{localize "Running"}}</span>
                    <div class="expertise-indicator {{#if system.attributes.move.running.expertise}}expertise-active{{else}}expertise-inactive{{/if}}">
                        {{#if system.attributes.move.running.expertise}}✔{{else}}✘{{/if}}
                    </div>
                </div>
                
                <div class="expertise-item" data-tooltip="<b>Climbing Expertise:</b> Grants the passive ability Cling. Cling allows you to dangle off of a surface you are climbing with one free hand, allowing you to perform one handed actions while occupying Climbing Terrain spaces. You can traverse Climbing spaces at a rate of 2 Movement per space.">
                    <span class="expertise-label">{{localize "Climbing"}}</span>
                    <div class="expertise-indicator {{#if system.attributes.move.climbing.expertise}}expertise-active{{else}}expertise-inactive{{/if}}">
                        {{#if system.attributes.move.climbing.expertise}}✔{{else}}✘{{/if}}
                    </div>
                </div>
                
                <div class="expertise-item" data-tooltip="<b>Marching Expertise:</b> You can traverse Marching spaces at a rate of 1 Movement per space.">
                    <span class="expertise-label">{{localize "Marching"}}</span>
                    <div class="expertise-indicator {{#if system.attributes.move.marching.expertise}}expertise-active{{else}}expertise-inactive{{/if}}">
                        {{#if system.attributes.move.marching.expertise}}✔{{else}}✘{{/if}}
                    </div>
                </div>
                
                <div class="expertise-item" data-tooltip="<b>Swimming Expertise:</b> Grants the passive Combat Floating. Floating removes the -4 penalty from players when they occupy a Swimming Terrain space. You can traverse Swimming spaces at a rate of 2 Movement per space.">
                    <span class="expertise-label">{{localize "Swimming"}}</span>
                    <div class="expertise-indicator {{#if system.attributes.move.swimming.expertise}}expertise-active{{else}}expertise-inactive{{/if}}">
                        {{#if system.attributes.move.swimming.expertise}}✔{{else}}✘{{/if}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <br />
    
    {{> "systems/stryder/templates/actor/parts/monster-battle.hbs"}}
</div>

    {{!-- Biography Tab --}}
    <div class="tab biography" data-group="primary" data-tab="description">
      <div class="biography-container">
        <div class="biography-section taxonomy-section">
          <h2 class="section-header">Taxonomy</h2>
          <p class="section-description"><em>Scientific classification, origins, and ecological context of this creature.</em></p>
          {{editor system.biography target="system.biography" rollData=rollData button=true owner=owner editable=editable}}
        </div>
        
        <div class="biography-section attitude-section">
          <h2 class="section-header">Behavior</h2>
          <p class="section-description"><em>Behavioral patterns, combat tactics, and situational responses.</em></p>
          {{editor system.attitude target="system.attitude" rollData=rollData button=true owner=owner editable=editable}}
        </div>
      </div>
    </div>

    {{!-- Active Effects Tab --}}
    <div class="tab effects flexcol" data-group="primary" data-tab="effects">
      {{> "systems/stryder/templates/actor/parts/actor-effects.hbs"}}
    </div>

  </section>
</form>

{{log system}}

