<h2 class="section-header" style="border-bottom: 0px;"><span class="header-decoration left"></span><img src="systems/stryder/assets/equipped-items.svg" width="25px" height="25px" style="border:0px; position: relative; top: 0px; left: -10px;"><strong>{{localize "Equipped Items"}}</strong><span class="header-decoration right"></span></h2>

{{!-- Reduction Display Boxes --}}
<div class="reduction-display">
  <div class="reduction-grid">
    <div class="reduction-box physical-reduction" data-reduction-type="physical">
      <div class="reduction-header">
        <img src="systems/stryder/assets/physical_reduction.svg" width="16px" height="16px" style="border:0px;" />
        <label class="reduction-label">{{localize "Physical Reduction"}}</label>
      </div>
      <input class="reduction-value" type="number" value="{{system.physical_reduction}}" readonly />
    </div>
    <div class="reduction-box magykal-reduction" data-reduction-type="magykal">
      <div class="reduction-header">
        <img src="systems/stryder/assets/magykal_reduction.svg" width="16px" height="16px" style="border:0px;" />
        <label class="reduction-label">{{localize "Magykal Reduction"}}</label>
      </div>
      <input class="reduction-value" type="number" value="{{system.magykal_reduction}}" readonly />
    </div>
  </div>
</div>

<script>
// Use Foundry VTT's hook system instead of DOMContentLoaded
Hooks.once('renderActorSheet', function(actorSheet, html, data) {
  // Initialize reduction tooltips after the sheet is rendered
  const reductionBoxes = html.find('.reduction-box');
  
  reductionBoxes.each(function() {
    const box = $(this);
    const tooltipType = box.data('reduction-type');
    
    box.on('mouseenter', function(e) {
      showReductionTooltip(e.currentTarget, tooltipType, actorSheet.actor);
    });
    
    box.on('mouseleave', function() {
      hideReductionTooltip();
    });
  });
});

function showReductionTooltip(element, type, actor) {
  // Remove any existing tooltip
  hideReductionTooltip();
  
  if (!actor) {
    console.warn('No actor provided to tooltip function');
    return;
  }
  
  // Get reduction sources
  const sources = getReductionSources(actor, type);
  
  if (sources.length === 0) {
    // Show message if no sources
    const tooltip = document.createElement('div');
    tooltip.className = 'reduction-tooltip';
    tooltip.innerHTML = `<h4>No ${type === 'physical' ? 'Physical' : 'Magykal'} Reduction sources</h4><p>Equip armor with reduction bonuses to see sources here.</p>`;
    
    document.body.appendChild(tooltip);
    positionTooltip(element, tooltip);
    
    setTimeout(() => {
      tooltip.classList.add('show');
    }, 10);
    return;
  }
  
  // Create tooltip
  const tooltip = document.createElement('div');
  tooltip.className = 'reduction-tooltip';
  
  const characterName = actor.name || 'Character';
  const reductionType = type === 'physical' ? 'Physical' : 'Magykal';
  
  let tooltipContent = `<h4>${characterName} is gaining ${reductionType} Reduction from these sources:</h4><ul>`;
  
  sources.forEach(source => {
    tooltipContent += `<li>${source.name} (+${source.bonus})</li>`;
  });
  
  tooltipContent += '</ul>';
  tooltip.innerHTML = tooltipContent;
  
  // Position and show tooltip
  document.body.appendChild(tooltip);
  positionTooltip(element, tooltip);
  
  setTimeout(() => {
    tooltip.classList.add('show');
  }, 10);
}

function positionTooltip(element, tooltip) {
  const rect = element.getBoundingClientRect();
  const tooltipRect = tooltip.getBoundingClientRect();
  
  // Position tooltip above the element
  tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltipRect.width / 2)}px`;
  tooltip.style.top = `${rect.top - tooltipRect.height - 10}px`;
  
  // Ensure tooltip stays within viewport
  const viewportWidth = window.innerWidth;
  const viewportHeight = window.innerHeight;
  
  if (parseInt(tooltip.style.left) < 10) {
    tooltip.style.left = '10px';
  } else if (parseInt(tooltip.style.left) + tooltipRect.width > viewportWidth - 10) {
    tooltip.style.left = `${viewportWidth - tooltipRect.width - 10}px`;
  }
  
  if (parseInt(tooltip.style.top) < 10) {
    tooltip.style.top = `${rect.bottom + 10}px`;
  }
}

function hideReductionTooltip() {
  const existingTooltip = document.querySelector('.reduction-tooltip');
  if (existingTooltip) {
    existingTooltip.remove();
  }
}

function getReductionSources(actor, type) {
  const sources = [];
  const armorTypes = ['head', 'legs', 'arms', 'back', 'gems'];
  
  actor.items.forEach(item => {
    if (armorTypes.includes(item.type) && item.system?.equipped !== false) {
      const bonusField = type === 'physical' ? 'physical_reduction_bonus' : 'magykal_reduction_bonus';
      const bonus = item.system?.[bonusField] || 0;
      
      if (bonus > 0) {
        sources.push({
          name: item.name,
          bonus: bonus
        });
      }
    }
  });
  
  return sources;
}
</script>

<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Aegis Core'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{aegiscore.length}}/2 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='aegiscore'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each aegiscore as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Soul Stones & Legacies'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{legacies.length}}/3 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='legacies'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each legacies as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Head'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{head.length}}/1 Slot)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='head'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each head as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Gems'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{gems.length}}/2 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='gems'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each gems as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Back'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{back.length}}/1 Slot)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='back'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each back as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Arms'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{armsSlotsUsed}}/2 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='arms'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each arms as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Legs'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{legs.length}}/1 Slot)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='legs'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each legs as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>

{{#unless isBangleless}}
<div class="vault-description">
    <h2 class="vault-title"><b>{{localize "The Vault"}}</b></h2>
    <p class="vault-text">
        {{localize "The Vault Description"}}
    </p>
</div>
{{else}}
<div class="vault-description" style="text-align: center; padding: 20px; border: 2px solid #8B4513; background-color: #F5E6D3; border-radius: 8px; margin: 10px 0;">
    <p style="font-style: italic; color: #8B4513; font-size: 16px; margin: 0;">
        Your Vault Bangle is not equipped, and so you cannot access your Vault.
    </p>
</div>
{{/unless}}
{{#unless isBangleless}}
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Loot'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{lootSlotsUsed}}/24 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='loot'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each loot as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
{{/unless}}
{{#unless isBangleless}}
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Components'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{component.length}}/10 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='component'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each component as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
{{/unless}}
{{#unless isBangleless}}
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Consumables'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{consumable.length}}/6 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='consumable'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each consumable as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
{{/unless}}
{{#unless isBangleless}}
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Gear'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <i>({{gearSlotsUsed}}/4 Slots)</i>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='gear'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each gear as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<ol class='items-list'>
  <li class='item flexrow items-header'>
    <div class='item-name'>{{localize 'Miscellaneous'}}&nbsp<i class='toggle-icon fas fa-chevron-down'></i></div>
    <div class='item-controls'>
      <a
        class='item-control item-create'
        title='Create item'
        data-type='miscellaneous'
      >
        <i class='fas fa-plus'></i>
        {{localize 'DOCUMENT.New' type=''}}
      </a>
    </div>
  </li>
  {{#each miscellaneous as |item id|}}
    <li class='item flexrow' data-item-id='{{item._id}}'>
      <div class='item-name'>
        <div class='item-image'>
          <a class='rollable' data-roll-type='item'>
            <img
              src='{{item.img}}'
              title='{{item.name}}'
              width='24'
              height='24'
            />
          </a>
        </div>
        <h4>{{item.name}}</h4>
      </div>
      <div class='item-controls'>
        <a
          class='item-control item-duplicate'
          title='{{localize "STRYDER.DOCUMENT.Duplicate"}}'
        >
          <i class='fas fa-copy'></i>
        </a>
        <a
          class='item-control item-edit'
          title='{{localize "DOCUMENT.Edit" type='feature'}}'
        >
          <i class='fas fa-edit'></i>
        </a>
        <a
          class='item-control item-delete'
          title='{{localize "DOCUMENT.Delete" type='feature'}}'
        >
          <i class='fas fa-trash'></i>
        </a>
      </div>
    </li>
  {{/each}}
</ol>
<br /><div class="character-race">
	<label for="{{actor._id}}grail" class="resource-label">{{localize "Grail"}}</label> 
	<input id="{{actor._id}}grail" type="text" name="system.grail" value="{{system.grail}}" placeholder="0" data-dtype="Number" style="width: 150px;"/>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<label for="{{actor._id}}guild_tokens" class="resource-label">{{localize "Guild Tokens"}}</label> 
	<input id="{{actor._id}}guild_tokens" type="text" name="system.guild_tokens" value="{{system.guild_tokens}}" placeholder="0" data-dtype="Number" style="width: 150px;"/>
</div>
{{/unless}}